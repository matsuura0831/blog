<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AWS Multi-account Strategy その2 | besolab</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="https://kit.fontawesome.com/845cc1d72b.js" crossorigin="anonymous"></script>
    <link rel="alternate" type="application/rss+xml" href="https://besolab.com/rss.xml" title="besolab RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://besolab.com/feed.atom" title="besolab Atom Feed">
    <link rel="alternate" type="application/json" href="https://besolab.com/feed.json" title="besolab JSON Feed">
    <meta name="description" content="1. コンプラ違反の検出(Config)">
    <meta name="google-site-verification" content="0q-QVeFFAfyqwV4y7aF2OGBbto4tctFQ0C8MjBRCQ54">
    
    <link rel="preload" href="/assets/css/0.styles.9c24b395.css" as="style"><link rel="preload" href="/assets/js/app.8db5a300.js" as="script"><link rel="preload" href="/assets/js/4.e19e9d07.js" as="script"><link rel="preload" href="/assets/js/1.e4e930b5.js" as="script"><link rel="preload" href="/assets/js/15.3410999e.js" as="script"><link rel="prefetch" href="/assets/js/10.aa4b6ad0.js"><link rel="prefetch" href="/assets/js/11.b526eccb.js"><link rel="prefetch" href="/assets/js/12.461ecd76.js"><link rel="prefetch" href="/assets/js/13.b63c3b91.js"><link rel="prefetch" href="/assets/js/14.6b7433e4.js"><link rel="prefetch" href="/assets/js/16.ddcc63de.js"><link rel="prefetch" href="/assets/js/2.0b69eb2a.js"><link rel="prefetch" href="/assets/js/5.0dfdf4b0.js"><link rel="prefetch" href="/assets/js/6.d4708a03.js"><link rel="prefetch" href="/assets/js/7.4b60eba1.js"><link rel="prefetch" href="/assets/js/8.40550b5e.js"><link rel="prefetch" href="/assets/js/9.710fc763.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9c24b395.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">besolab</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SNS" class="dropdown-title"><span class="title">SNS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://twitter.com/matsuura0831/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/matsuura0831/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SNS" class="dropdown-title"><span class="title">SNS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://twitter.com/matsuura0831/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/matsuura0831/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>AWS Multi-account Strategy その2</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2021/03/19/aws-multi-account-strategy/#はじめに" class="sidebar-link">はじめに</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2021/03/19/aws-multi-account-strategy/#cfn" class="sidebar-link">CFn</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2021/03/19/aws-multi-account-strategy/#監査アカウントの設定" class="sidebar-link">監査アカウントの設定</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2021/03/19/aws-multi-account-strategy/#セキュリティ通知" class="sidebar-link">セキュリティ通知</a></li><li class="sidebar-sub-header"><a href="/2021/03/19/aws-multi-account-strategy/#config集約設定" class="sidebar-link">Config集約設定</a></li></ul></li><li><a href="/2021/03/19/aws-multi-account-strategy/#ログアカウントの設定" class="sidebar-link">ログアカウントの設定</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="aws-multi-account-strategy-その2"><a href="#aws-multi-account-strategy-その2" class="header-anchor">#</a> AWS Multi-account strategy その2</h1> <p>前回からの続きで，作成したアカウントに対してガバナンスを効かせる方法について整理する．</p> <p>なお東京リージョン以外でのリソース作成をOrganizationsのSCP機能で限定しているので，東京リージョンのみを考慮した書き方をしている．
他リージョンでのリソース作成を許可している場合はそっちも一緒にやること．</p> <h2 id="はじめに"><a href="#はじめに" class="header-anchor">#</a> はじめに</h2> <p>企業ルールによって色々とバリエーションはあるが，ざっと下記設定ができれば大半はカバーできるのではないかと思う．</p> <ol><li>コンプラ違反の検出(Config)
<ul><li>各リソース作成時にルールを守って作成しているかを判定し，違反リソースが一目で見てわかる</li> <li>Auditアカウント上で複数アカウントの判定結果を集約して見ることもできる</li> <li>自由に使ってもらいつつも最低限守ってほしいことはチェックするために利用</li></ul></li> <li>監査用ログの自動収集(CloudTrail, CloudWatch)と保存(S3)とレポート作成(Athena)
<ul><li>AWSリソースの操作履歴をCloudTrailで，各ログをCloudWatchで確認できる</li> <li>手順5との組み合わせでEC2のログ情報もCloudWatchで確認できるようにする(操作ログも含)</li> <li>監査用ログ提出を求められた際にありません！ってならないように利用</li></ul></li> <li>各種検出時のメール通知(SNS: SimpleNotificationService)
<ul><li>ConfigやCloudTrailで検出したセキュリティ通知をメールに転送する</li> <li>Auditアカウント上で購読設定するだけで複数アカウントのセキュリティ通知を集約して受け取れる</li> <li>緊急対応が必要な場合をメールですぐわかるように利用(ちょっと改造すればslackとかでも受け取れる)</li></ul></li> <li>脅威検出の設定(GuadDuty)
<ul><li>AWSマネージドな脅威検出機能</li> <li>ウィルス対策ソフトとかWAF/IPS/IDSとかの代わりにはなれないけれど，あまりお金もかからないのでとりあえず有効にしとくとよい</li></ul></li> <li>セキュリティ対策済みのEC2イメージ配布(EC2ImageBuilder, Ansible)
<ul><li>必須ソフトウェアをインストールしたEC2イメージを作成して配布する(ウィルス対策ソフトとか)</li> <li>ついでにログ情報をCloudWatchにアップロードするように設定もしてしまう</li> <li>設定漏れ・ミスを防ぐために利用</li></ul></li> <li>EC2ログイン用の鍵とユーザ管理(SSM-SessionManager)
<ul><li>鍵不要でもセキュアにSSH接続ができる</li> <li>EC2の鍵とユーザ管理から解放されるために利用(建付け次第で管理簿が減らせるはず)</li></ul></li> <li>EC2のアプリケーションバージョン管理(SSM-inventory)
<ul><li>EC2にインストールされているアプリケーションのバージョン確認</li> <li>セキュリティパッチが出てたら自動で適用するために利用(監視・保守労力を削減)</li></ul></li></ol> <p>プラスアルファの対応が求められる場合場合は頑張って．</p> <p>なお各アカウントにて手作業で設定するのはあほらしいのでCFn(CloudFormation)により上記を行えるようにしたほうが良い．
今回はCFnの設定と，本格的に新規作成アカウントの設定を行う前にAuditアカウントとLogアカウントの設定を説明する．</p> <p>AuditとLogアカウントの位置づけは前回参照．</p> <h2 id="cfn"><a href="#cfn" class="header-anchor">#</a> CFn</h2> <p>CloudFormationはテンプレートに沿ってAWSリソースを作成できる機能．
AWSの設定の殆どが自動化でき，さらにOrganizations環境下ではMasterアカウントから各サブアカウントに作成指示を出すことができる．
自アカウント上で作成する際はStack機能，サブアカウントに作成指示を出す際はStackSets機能をそれぞれ利用する．</p> <p>アカウントが数個レベルなら手作業でやってもよいが(それでも間違うときは間違うので<strong>絶対にやめたほうが良い</strong>)，数十個超えると死ぬので必須だと思ったほうが良い．
利用するにあたってはMasterアカウント上での設定と，各サブアカウント上での設定の大きく2種類が必要となる．</p> <p>MasterアカウントでStackSetsを実行するIAMロール(AdministrationRole)を作成し，対象となるサブアカウント(移行，Targetアカウントと呼ぶ)でリソースを作成するIAMロール(ExecutionRole)を作成する．</p> <p>ちょっと細かい話をすると，</p> <ol><li>StackSetsをAdministrationRole@Masterロールで実行する</li> <li>AdministrationRole@MasterからExecutionRole@TargetにAssumeRoleする</li> <li>Targetアカウント上でテンプレートをExecutionRoleロールで実行する</li></ol> <p>という動きをする．
セキュリティ対策のためExecutionRoleはMasterアカウントのAdministrationRoleからのみAssumeRoleを許容するようにすること．</p> <p>各アカウントの<a href="https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks" target="_blank" rel="noopener noreferrer">CFnのStackダッシュボード<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>に移動し，以下のパラメータで実行する．
AWSがテンプレートを用意してくれているので活用する．</p> <p>Masterアカウントの設定</p> <ul><li>テンプレートソース: Amazon S3 URL</li> <li>Amazon S3 URL: <a href="https://s3.amazonaws.com/cloudformation-stackset-templates-us-east-1/master_account_role.template" target="_blank" rel="noopener noreferrer">https://s3.amazonaws.com/cloudformation-stackset-templates-us-east-1/master_account_role.template<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>スタックの名前: common-role-cfn-admin</li></ul> <p>Targetアカウントの設定</p> <ul><li>テンプレートソース: Amazon S3 URL</li> <li>Amazon S3 URL: <a href="https://s3.amazonaws.com/cloudformation-stackset-templates-us-east-1/managed_account_role.template" target="_blank" rel="noopener noreferrer">https://s3.amazonaws.com/cloudformation-stackset-templates-us-east-1/managed_account_role.template<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>スタックの名前: common-role-cfn-execute</li></ul> <h2 id="監査アカウントの設定"><a href="#監査アカウントの設定" class="header-anchor">#</a> 監査アカウントの設定</h2> <p>Auditアカウント(監査機能・通知を集約するアカウント)を設定する．</p> <p>大きく2つの設定を行う．</p> <ol><li>セキュリティ通知をメールで受け取れるようにする</li> <li>Config集約する</li></ol> <p>CfnのTargetアカウントの設定が実行しておくこと．</p> <h3 id="セキュリティ通知"><a href="#セキュリティ通知" class="header-anchor">#</a> セキュリティ通知</h3> <p>2つのSNSトピック作成とメール購読設定を行う．</p> <ul><li>SNSAllConfigurationトピック
<ul><li>Auditアカウント上でのConfigとCloudTrailのセキュリティ通知用トピック</li> <li>後の設定で全アカウントのConfig監視がAuditアカウントに集約されて，めっちゃメールが飛んでくるので注意</li></ul></li> <li>SNSNotificationトピック
<ul><li>Targetアカウントのセキュリティ通知を集約して受け取るためのトピック</li></ul></li></ul> <p>以下の内容で<code>security-topic.yml</code>を作成する．</p> <details class="custom-block details"><summary>DETAILS</summary> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">AWSTemplateFormatVersion</span><span class="token punctuation">:</span> <span class="token datetime number">2010-09-09</span>
<span class="token key atrule">Description</span><span class="token punctuation">:</span> Configure the SNS Topics for Security Account

<span class="token key atrule">Parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">ManagedResourcePrefix</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'Prefix for the managed resources'</span>
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token string">&quot;aws-organizations&quot;</span>
  <span class="token key atrule">AllConfigurationEmail</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Email for receiving all AWS configuration events
  <span class="token key atrule">SecurityNotificationEmail</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Email for the security administrators
  <span class="token key atrule">OrgID</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> AWS Organizations ID
  <span class="token key atrule">SubscribeToAllConfigurationTopic</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Indicates whether AllConfigurationEmail will be subscribed to the AllConfigurationTopicName topic.
    <span class="token key atrule">AllowedValues</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token boolean important">true</span>
      <span class="token punctuation">-</span> <span class="token boolean important">false</span>

<span class="token key atrule">Conditions</span><span class="token punctuation">:</span>
  <span class="token key atrule">Subscribe</span><span class="token punctuation">:</span> <span class="token tag">!Equals</span>
    <span class="token punctuation">-</span> <span class="token tag">!Ref</span> SubscribeToAllConfigurationTopic
    <span class="token punctuation">-</span> <span class="token string">'true'</span>

<span class="token key atrule">Mappings</span><span class="token punctuation">:</span>
  <span class="token key atrule">TopicNameSuffix</span><span class="token punctuation">:</span>
    <span class="token key atrule">AllConfigurationTopicName</span><span class="token punctuation">:</span>
      <span class="token key atrule">Suffix</span><span class="token punctuation">:</span> <span class="token string">'AllConfigNotifications'</span>
    <span class="token key atrule">NotifyTopicName</span><span class="token punctuation">:</span>
      <span class="token key atrule">Suffix</span><span class="token punctuation">:</span> <span class="token string">'AggregateSecurityNotifications'</span>

<span class="token key atrule">Resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">SNSAllConfigurationTopic</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>SNS<span class="token punctuation">:</span><span class="token punctuation">:</span>Topic
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">DisplayName</span><span class="token punctuation">:</span> <span class="token tag">!Join</span> <span class="token punctuation">[</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token tag">!Ref</span> ManagedResourcePrefix<span class="token punctuation">,</span> <span class="token tag">!FindInMap</span> <span class="token punctuation">[</span>TopicNameSuffix<span class="token punctuation">,</span> AllConfigurationTopicName<span class="token punctuation">,</span> Suffix<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token key atrule">TopicName</span><span class="token punctuation">:</span> <span class="token tag">!Join</span> <span class="token punctuation">[</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token tag">!Ref</span> ManagedResourcePrefix<span class="token punctuation">,</span> <span class="token tag">!FindInMap</span> <span class="token punctuation">[</span>TopicNameSuffix<span class="token punctuation">,</span> AllConfigurationTopicName<span class="token punctuation">,</span> Suffix<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>

  <span class="token key atrule">SNSAllConfigurationTopicPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>SNS<span class="token punctuation">:</span><span class="token punctuation">:</span>TopicPolicy
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">Topics</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token tag">!Ref</span> SNSAllConfigurationTopic
      <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>
        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Sid</span><span class="token punctuation">:</span> AWSSNSPolicy
            <span class="token key atrule">Action</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> sns<span class="token punctuation">:</span>Publish
            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SNSAllConfigurationTopic
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">Service</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> cloudtrail.amazonaws.com
                <span class="token punctuation">-</span> config.amazonaws.com

  <span class="token key atrule">SNSAllConfigurationEmailNotification</span><span class="token punctuation">:</span>
    <span class="token key atrule">Condition</span><span class="token punctuation">:</span> Subscribe
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>SNS<span class="token punctuation">:</span><span class="token punctuation">:</span>Subscription
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">Endpoint</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> AllConfigurationEmail
      <span class="token key atrule">Protocol</span><span class="token punctuation">:</span> email
      <span class="token key atrule">TopicArn</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SNSAllConfigurationTopic

  <span class="token key atrule">SNSNotification</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>SNS<span class="token punctuation">:</span><span class="token punctuation">:</span>Topic
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">DisplayName</span><span class="token punctuation">:</span> <span class="token tag">!Join</span> <span class="token punctuation">[</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token tag">!Ref</span> ManagedResourcePrefix<span class="token punctuation">,</span> <span class="token tag">!FindInMap</span> <span class="token punctuation">[</span>TopicNameSuffix<span class="token punctuation">,</span> NotifyTopicName<span class="token punctuation">,</span> Suffix<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token key atrule">TopicName</span><span class="token punctuation">:</span> <span class="token tag">!Join</span> <span class="token punctuation">[</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token tag">!Ref</span> ManagedResourcePrefix<span class="token punctuation">,</span> <span class="token tag">!FindInMap</span> <span class="token punctuation">[</span>TopicNameSuffix<span class="token punctuation">,</span> NotifyTopicName<span class="token punctuation">,</span> Suffix<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token key atrule">Subscription</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">Protocol</span><span class="token punctuation">:</span> email
        <span class="token key atrule">Endpoint</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SecurityNotificationEmail

  <span class="token key atrule">SNSNotificationPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>SNS<span class="token punctuation">:</span><span class="token punctuation">:</span>TopicPolicy
    <span class="token key atrule">Metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">cfn_nag</span><span class="token punctuation">:</span>
        <span class="token key atrule">rules_to_suppress</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> F18
            <span class="token key atrule">reason</span><span class="token punctuation">:</span> <span class="token string">&quot;Conditions restrict permissions to Organization account and publishing only to member accounts.&quot;</span>
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">Topics</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token tag">!Ref</span> SNSNotification
      <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>
        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Sid</span><span class="token punctuation">:</span> __default_statement_ID
            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">AWS</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
            <span class="token key atrule">Action</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>GetTopicAttributes
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>SetTopicAttributes
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>AddPermission
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>RemovePermission
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>DeleteTopic
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>Subscribe
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>ListSubscriptionsByTopic
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>Publish
            <span class="token punctuation">-</span> SNS<span class="token punctuation">:</span>Receive
            <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SNSNotification
            <span class="token key atrule">Condition</span><span class="token punctuation">:</span>
              <span class="token key atrule">StringEquals</span><span class="token punctuation">:</span>
                <span class="token key atrule">AWS:SourceOwner</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> $<span class="token punctuation">{</span>AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>AccountId<span class="token punctuation">}</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Sid</span><span class="token punctuation">:</span> AWSSNSPolicy
            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">AWS</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
            <span class="token key atrule">Action</span><span class="token punctuation">:</span> sns<span class="token punctuation">:</span>Publish
            <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SNSNotification
            <span class="token key atrule">Condition</span><span class="token punctuation">:</span>
              <span class="token key atrule">StringEquals</span><span class="token punctuation">:</span>
                <span class="token key atrule">aws:PrincipalOrgID</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> OrgID

<span class="token key atrule">Outputs</span><span class="token punctuation">:</span>
  <span class="token key atrule">SecurityTopicARN</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Security Notification SNS Topic ARN
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SNSNotification
  <span class="token key atrule">SecurityTopicName</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Security Notification SNS Topic Name
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> SNSNotification.TopicName
  <span class="token key atrule">AllConfigTopicARN</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> All Configuration Notification SNS Topic ARN
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SNSAllConfigurationTopic
  <span class="token key atrule">AllConfigTopicName</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> All Configuration Notification SNS Topic Name
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> SNSAllConfigurationTopic.TopicName
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br></div></div></details> <p>パラメータのうち重要なものを説明．</p> <ul><li>AllConfigurationEmail: SNSAllConfigurationトピックを受け取るメールアドレス</li> <li>SecurityNotificationEmail: SNSNotificationトピックを受け取るメールアドレス</li> <li>OrgID: OrganizationsのID．Masterアカウント上で調べたのを記載</li> <li>SubscribeToAllConfigurationTopic: AllConfigurationEmail有効化のフラグ．trueだと通知が飛ぶ．めっちゃ多いのでプログラム処理しない限りfalse推奨</li></ul> <p>以下のように実行する．Masterアカウントのcredentialを取得して設定しておくこと．</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token assign-left variable">EMAIL_ALL</span><span class="token operator">=</span><span class="token string">'&quot;&lt;全通知を受けるメールアドレス&gt;&quot;'</span>
<span class="token assign-left variable">EMAIL_NOTIFY</span><span class="token operator">=</span><span class="token string">'&quot;&lt;セキュリティ通知を受けるメールアドレス&gt;&quot;'</span>

<span class="token assign-left variable">STACK_NAME</span><span class="token operator">=</span>AWSOrganizations-SecurityTopic
<span class="token assign-left variable">REGIONS</span><span class="token operator">=</span><span class="token string">'[&quot;ap-northeast-1&quot;]'</span>
<span class="token assign-left variable">ORG_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>aws organizations describe-organization <span class="token operator">|</span> jq <span class="token string">&quot;.Organization.Id&quot;</span><span class="token variable">`</span></span>
<span class="token assign-left variable">ACCOUNT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>aws organizations list-accounts <span class="token operator">|</span> jq <span class="token string">'.Accounts[] | select(.Name == &quot;audit&quot;) | .Id'</span><span class="token variable">`</span></span>

aws cloudformation create-stack-set --stack-set-name <span class="token variable">${STACK_NAME}</span> --template-body file://security-topic.yml
  --parameters <span class="token punctuation">\</span>
    <span class="token assign-left variable">ParameterKey</span><span class="token operator">=</span>AllConfigurationEmail,ParameterValue<span class="token operator">=</span><span class="token variable">${EMAIL_ALL}</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">ParameterKey</span><span class="token operator">=</span>SecurityNotificationEmail,ParameterValue<span class="token operator">=</span><span class="token variable">${EMAIL_NOTIFY}</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">ParameterKey</span><span class="token operator">=</span>OrgID,ParameterValue<span class="token operator">=</span><span class="token variable">${ORG_ID}</span>

aws cloudformation create-stack-instances --stack-set-name <span class="token variable">${STACK_NAME}</span> --accounts <span class="token string">&quot;[<span class="token variable">${ACCOUNT}</span>]&quot;</span> --regions <span class="token variable">${REGIONS}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="config集約設定"><a href="#config集約設定" class="header-anchor">#</a> Config集約設定</h3> <p>以下の内容で<code>security-resource.yml</code>を作成する．</p> <details class="custom-block details"><summary>DETAILS</summary> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">AWSTemplateFormatVersion</span><span class="token punctuation">:</span> <span class="token datetime number">2010-09-09</span>
<span class="token key atrule">Description</span><span class="token punctuation">:</span> Configure the Cross<span class="token punctuation">-</span>Account IAM Audit Roles for Audit Account

<span class="token key atrule">Parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">ManagedResourcePrefix</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'Prefix for the managed resources'</span>
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token string">'aws-organizations'</span>
  <span class="token key atrule">Accounts</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'Account Ids with csv'</span>

<span class="token key atrule">Resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">AdministrationRole</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>IAM<span class="token punctuation">:</span><span class="token punctuation">:</span>Role
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">RoleName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> $<span class="token punctuation">{</span>ManagedResourcePrefix<span class="token punctuation">}</span><span class="token punctuation">-</span>AuditAdministratorRole
      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>
        <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token datetime number">2012-10-17</span>
        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">Service</span><span class="token punctuation">:</span> lambda.amazonaws.com
            <span class="token key atrule">Action</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole
      <span class="token key atrule">Path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">ManagedPolicyArns</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>aws<span class="token punctuation">:</span>policy/AWSLambdaExecute
      <span class="token key atrule">Policies</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> AssumeRole<span class="token punctuation">-</span>$<span class="token punctuation">{</span>ManagedResourcePrefix<span class="token punctuation">}</span><span class="token punctuation">-</span>AuditAdministratorRole
          <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>
            <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token datetime number">2012-10-17</span>
            <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
                <span class="token key atrule">Action</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole
                <span class="token key atrule">Resource</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token tag">!Sub</span> <span class="token string">&quot;arn:aws:iam::*:role/${ManagedResourcePrefix}-AdministratorExecutionRole&quot;</span>

  <span class="token key atrule">ReadOnlyRole</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>IAM<span class="token punctuation">:</span><span class="token punctuation">:</span>Role
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">RoleName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> $<span class="token punctuation">{</span>ManagedResourcePrefix<span class="token punctuation">}</span><span class="token punctuation">-</span>AuditReadOnlyRole
      <span class="token key atrule">AssumeRolePolicyDocument</span><span class="token punctuation">:</span>
        <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token datetime number">2012-10-17</span>
        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">Service</span><span class="token punctuation">:</span> lambda.amazonaws.com
            <span class="token key atrule">Action</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole
      <span class="token key atrule">Path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">ManagedPolicyArns</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>aws<span class="token punctuation">:</span>policy/AWSLambdaExecute
      <span class="token key atrule">Policies</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">PolicyName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> AssumeRole<span class="token punctuation">-</span>$<span class="token punctuation">{</span>ManagedResourcePrefix<span class="token punctuation">}</span><span class="token punctuation">-</span>AuditReadOnlyRole
          <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>
            <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token datetime number">2012-10-17</span>
            <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
                <span class="token key atrule">Action</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> sts<span class="token punctuation">:</span>AssumeRole
                <span class="token key atrule">Resource</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token tag">!Sub</span> <span class="token string">&quot;arn:aws:iam::*:role/${ManagedResourcePrefix}-ReadOnlyExecutionRole&quot;</span>

  <span class="token key atrule">ConfigAggregator</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Config<span class="token punctuation">:</span><span class="token punctuation">:</span>ConfigurationAggregator
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">AccountAggregationSources</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">AccountIds</span><span class="token punctuation">:</span> <span class="token tag">!Split</span> <span class="token punctuation">[</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token tag">!Ref</span> Accounts<span class="token punctuation">]</span>
          <span class="token key atrule">AllAwsRegions</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">ConfigurationAggregatorName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> $<span class="token punctuation">{</span>ManagedResourcePrefix<span class="token punctuation">}</span><span class="token punctuation">-</span>ConfigAggregator

<span class="token key atrule">Outputs</span><span class="token punctuation">:</span>
  <span class="token key atrule">CrossAccountAdminRole</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Audit Administrator Role
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> <span class="token string">'AdministrationRole.Arn'</span>
  <span class="token key atrule">CrossAccountReadOnlyRole</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Audit ReadOnly Role
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> <span class="token string">'ReadOnlyRole.Arn'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div></details> <p>以下のように実行する．Masterアカウントのcredentialを取得して設定しておくこと．</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token assign-left variable">STACK_NAME</span><span class="token operator">=</span>AWSOrganizations-SecurityResource
<span class="token assign-left variable">REGIONS</span><span class="token operator">=</span><span class="token string">'[&quot;ap-northeast-1&quot;]'</span>

<span class="token assign-left variable">ACCOUNT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>aws organizations list-accounts <span class="token operator">|</span> jq <span class="token string">'.Accounts[] | select(.Name == &quot;audit&quot;) | .Id'</span><span class="token variable">`</span></span>
<span class="token assign-left variable">TARGET_ACCOUNT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>aws organizations list-accounts <span class="token operator">|</span> jq <span class="token string">'[.Accounts[] | select(.Name != &quot;master&quot; and .Name != &quot;audit&quot; and .Name != &quot;log&quot;) | .Id] | join(&quot;,&quot;)'</span><span class="token variable">`</span></span>

aws cloudformation create-stack-set --stack-set-name <span class="token variable">${STACK_NAME}</span> --template-body file://security-resource.yml --capabilities CAPABILITY_NAMED_IAM --parameters <span class="token string">&quot;ParameterKey=Accounts,ParameterValue=<span class="token variable">${TARGET_ACCOUNT}</span>&quot;</span>
aws cloudformation create-stack-instances --stack-set-name <span class="token variable">${STACK_NAME}</span> --accounts <span class="token string">&quot;[<span class="token variable">${ACCOUNT}</span>]&quot;</span> --regions <span class="token variable">${REGIONS}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="ログアカウントの設定"><a href="#ログアカウントの設定" class="header-anchor">#</a> ログアカウントの設定</h2> <p>Logアカウント(各種ログの集約するアカウント)の設定を行う．
CfnのTargetアカウントの設定が実行しておくこと．</p> <p>以下のS3バケットを作成する．</p> <ul><li>S3アクセスログ: <code>${ManagedResourcePrefix}-s3-access-logs-${AWS::AccountId}-${AWS::Region}</code> <ul><li>各種ログの改ざん防止に．詳細ログを記録</li></ul></li> <li>各種ログ: <code>${ManagedResourcePrefix}-logs-${AWS::AccountId}-${AWS::Region}</code> <ul><li>Targetアカウントの各種ログが集約さる</li></ul></li></ul> <p>以下の内容で<code>logging-resource.yml</code>を作成する．</p> <details class="custom-block details"><summary>DETAILS</summary> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">AWSTemplateFormatVersion</span><span class="token punctuation">:</span> <span class="token datetime number">2010-09-09</span>
<span class="token key atrule">Description</span><span class="token punctuation">:</span> Configure an Audit S3 bucket for the Log Archive account.

<span class="token key atrule">Parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">SSEAlgorithm</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token string">'AES256'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> S3 bucket SSE Algorithm.
    <span class="token key atrule">AllowedValues</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'AES256'</span>
  <span class="token key atrule">ManagedResourcePrefix</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'Prefix for the managed resources'</span>
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token string">&quot;aws-organizations&quot;</span>
  <span class="token key atrule">RetentionDays</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'No of Days to retain the logs, after which it will be permanently deleted'</span>
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">365</span>
  <span class="token key atrule">TransitionToGlacier</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'Do you wish to transition the logs to Glacier before permanently deleting?'</span>
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token string">'No'</span>
    <span class="token key atrule">AllowedValues</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'Yes'</span>
    <span class="token punctuation">-</span> <span class="token string">'No'</span>
  <span class="token key atrule">TransitionDays</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> String
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'No of Days to transition the data from S3 to Glacier'</span>
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">90</span>
  <span class="token key atrule">AWSLogsS3KeyPrefix</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">'String'</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> <span class="token string">'Organization ID to use as the S3 Key prefix for storing the audit logs'</span>

<span class="token key atrule">Conditions</span><span class="token punctuation">:</span>
  <span class="token key atrule">MoveToGlacier</span><span class="token punctuation">:</span> <span class="token tag">!Equals</span>
    <span class="token punctuation">-</span> <span class="token tag">!Ref</span> TransitionToGlacier
    <span class="token punctuation">-</span> <span class="token string">'Yes'</span>

<span class="token key atrule">Resources</span><span class="token punctuation">:</span>
  <span class="token comment"># Create S3 Server Access Logging bucket</span>
  <span class="token key atrule">S3LoggingBucket</span><span class="token punctuation">:</span>
    <span class="token key atrule">DeletionPolicy</span><span class="token punctuation">:</span> Retain
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>S3<span class="token punctuation">:</span><span class="token punctuation">:</span>Bucket
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">BucketName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> $<span class="token punctuation">{</span>ManagedResourcePrefix<span class="token punctuation">}</span><span class="token punctuation">-</span>s3<span class="token punctuation">-</span>access<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>$<span class="token punctuation">{</span>AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>AccountId<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Region<span class="token punctuation">}</span>
      <span class="token key atrule">AccessControl</span><span class="token punctuation">:</span> LogDeliveryWrite
      <span class="token key atrule">VersioningConfiguration</span><span class="token punctuation">:</span>
        <span class="token key atrule">Status</span><span class="token punctuation">:</span> Enabled
      <span class="token key atrule">BucketEncryption</span><span class="token punctuation">:</span>
        <span class="token key atrule">ServerSideEncryptionConfiguration</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">ServerSideEncryptionByDefault</span><span class="token punctuation">:</span>
              <span class="token key atrule">SSEAlgorithm</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SSEAlgorithm
  <span class="token comment"># Create S3 Audit bucket</span>
  <span class="token key atrule">S3AuditBucket</span><span class="token punctuation">:</span>
    <span class="token key atrule">DeletionPolicy</span><span class="token punctuation">:</span> Retain
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>S3<span class="token punctuation">:</span><span class="token punctuation">:</span>Bucket
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">BucketName</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> $<span class="token punctuation">{</span>ManagedResourcePrefix<span class="token punctuation">}</span><span class="token punctuation">-</span>logs<span class="token punctuation">-</span>$<span class="token punctuation">{</span>AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>AccountId<span class="token punctuation">}</span><span class="token punctuation">-</span>$<span class="token punctuation">{</span>AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Region<span class="token punctuation">}</span>
      <span class="token key atrule">VersioningConfiguration</span><span class="token punctuation">:</span>
        <span class="token key atrule">Status</span><span class="token punctuation">:</span> Enabled
      <span class="token key atrule">LoggingConfiguration</span><span class="token punctuation">:</span>
        <span class="token key atrule">DestinationBucketName</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> S3LoggingBucket
      <span class="token key atrule">BucketEncryption</span><span class="token punctuation">:</span>
        <span class="token key atrule">ServerSideEncryptionConfiguration</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">ServerSideEncryptionByDefault</span><span class="token punctuation">:</span>
              <span class="token key atrule">SSEAlgorithm</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> SSEAlgorithm
      <span class="token key atrule">LifecycleConfiguration</span><span class="token punctuation">:</span>
        <span class="token key atrule">Rules</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token tag">!If</span>
          <span class="token punctuation">-</span> MoveToGlacier
          <span class="token punctuation">-</span> <span class="token key atrule">Id</span><span class="token punctuation">:</span> RetentionRule
            <span class="token key atrule">Status</span><span class="token punctuation">:</span> Enabled
            <span class="token key atrule">ExpirationInDays</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> RetentionDays
            <span class="token key atrule">NoncurrentVersionExpirationInDays</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> RetentionDays
            <span class="token key atrule">Transitions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">TransitionInDays</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> TransitionDays
                  <span class="token key atrule">StorageClass</span><span class="token punctuation">:</span> Glacier
            <span class="token key atrule">NoncurrentVersionTransitions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">TransitionInDays</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> TransitionDays
                  <span class="token key atrule">StorageClass</span><span class="token punctuation">:</span> Glacier
          <span class="token punctuation">-</span> <span class="token key atrule">Id</span><span class="token punctuation">:</span> RetentionRule
            <span class="token key atrule">Status</span><span class="token punctuation">:</span> Enabled
            <span class="token key atrule">ExpirationInDays</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> RetentionDays
            <span class="token key atrule">NoncurrentVersionExpirationInDays</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> RetentionDays
  <span class="token comment"># Create Bucket Policy for S3 Audit bucket</span>
  <span class="token key atrule">S3AuditBucketPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>S3<span class="token punctuation">:</span><span class="token punctuation">:</span>BucketPolicy
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">Bucket</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> S3AuditBucket
      <span class="token key atrule">PolicyDocument</span><span class="token punctuation">:</span>
        <span class="token key atrule">Version</span><span class="token punctuation">:</span> <span class="token datetime number">2012-10-17</span>
        <span class="token key atrule">Statement</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Sid</span><span class="token punctuation">:</span> AWSBucketPermissionsCheck
            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">Service</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> cloudtrail.amazonaws.com
                <span class="token punctuation">-</span> config.amazonaws.com
            <span class="token key atrule">Action</span><span class="token punctuation">:</span> s3<span class="token punctuation">:</span>GetBucketAcl
            <span class="token key atrule">Resource</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token tag">!Sub</span> <span class="token string">&quot;arn:aws:s3:::${S3AuditBucket}&quot;</span>
          <span class="token punctuation">-</span> <span class="token key atrule">Sid</span><span class="token punctuation">:</span> AWSBucketDelivery
            <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow
            <span class="token key atrule">Principal</span><span class="token punctuation">:</span>
              <span class="token key atrule">Service</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> cloudtrail.amazonaws.com
                <span class="token punctuation">-</span> config.amazonaws.com
            <span class="token key atrule">Action</span><span class="token punctuation">:</span> s3<span class="token punctuation">:</span>PutObject
            <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token tag">!Sub</span> <span class="token string">&quot;arn:aws:s3:::${S3AuditBucket}/${AWSLogsS3KeyPrefix}/AWSLogs/*/*&quot;</span>

<span class="token key atrule">Outputs</span><span class="token punctuation">:</span>
  <span class="token key atrule">BucketName</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> Audit S3 bucket name
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> S3AuditBucket
  <span class="token key atrule">LoggingBucketName</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> S3 Access Logging Bucket name
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> S3LoggingBucket
  <span class="token key atrule">AuditLogsS3KeyPrefix</span><span class="token punctuation">:</span>
    <span class="token key atrule">Description</span><span class="token punctuation">:</span> S3 Key prefix for storing the audit logs
    <span class="token key atrule">Value</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> AWSLogsS3KeyPrefix
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div></details> <p>パラメータのうち重要なものを説明．</p> <ul><li>RetentionDays: 保持期間．適切に設定すべし</li> <li>AWSLogsS3KeyPrefix: バケットのPrefix名の設定．基本何でもいいけど，私はOrganizationsのIDにすることが多い</li></ul> <p>以下のように実行する．Masterアカウントのcredentialを取得して設定しておくこと．</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token assign-left variable">STACK_NAME</span><span class="token operator">=</span>AWSOrganizations-LoggingResource
<span class="token assign-left variable">REGIONS</span><span class="token operator">=</span><span class="token string">'[&quot;ap-northeast-1&quot;]'</span>

<span class="token assign-left variable">ACCOUNT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>aws organizations list-accounts <span class="token operator">|</span> jq <span class="token string">'.Accounts[] | select(.Name == &quot;log&quot;) | .Id'</span><span class="token variable">`</span></span>
<span class="token assign-left variable">ORG_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>aws organizations describe-organization <span class="token operator">|</span> jq <span class="token string">&quot;.Organization.Id&quot;</span><span class="token variable">`</span></span>

aws cloudformation create-stack-set --stack-set-name <span class="token variable">${STACK_NAME}</span> --template-body file://logging-resource.yml <span class="token punctuation">\</span>
  --parameters <span class="token string">&quot;ParameterKey=AWSLogsS3KeyPrefix,ParameterValue=<span class="token variable">${ORG_ID}</span>&quot;</span>

aws cloudformation create-stack-instances --stack-set-name <span class="token variable">${STACK_NAME}</span> --accounts <span class="token string">&quot;[<span class="token variable">${ACCOUNT}</span>]&quot;</span> --regions <span class="token variable">${REGIONS}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2021/3/20 9:29:24</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8db5a300.js" defer></script><script src="/assets/js/4.e19e9d07.js" defer></script><script src="/assets/js/1.e4e930b5.js" defer></script><script src="/assets/js/15.3410999e.js" defer></script>
  </body>
</html>
